<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet">
</head>

<body data-bs-theme="dark" style="background:black">

<div class="container-fluid p-4 text-white">

  <!-- HEADER -->
  <div class="position-relative mb-4">

    <!-- LOGO SOL -->
    <div class="position-absolute start-0">
      <img src="/logo.png" style="height:48px">
    </div>

    <!-- BAŞLIK ORTA -->
    <div class="text-center">
      <h4 class="mb-0 fw-semibold">Destek Talepleri</h4>
    </div>

    <!-- ÇIKIŞ SAĞ -->
    <div class="position-absolute end-0 top-0">
      <form method="POST" action="/logout">
        <button class="btn btn-warning btn-sm">Çıkış</button>
      </form>
    </div>

  </div>

  <!-- TABLE -->
  <table class="table table-dark table-hover align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>Email</th>
        <th>Departman</th>
        <th>Sorun</th>
        <th>Geliş Zamanı</th>
        <th>Durum</th>
        <th>SLA</th>
        <th class="text-end">İşlem</th>
      </tr>
    </thead>

    <tbody>
    <% 
      const fmt = new Intl.DateTimeFormat('tr-TR', {
        timeZone: 'Europe/Istanbul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    %>

    <% if (!tickets.length) { %>
      <tr>
        <td colspan="8" class="text-center text-white-50 py-4">
          Gösterilecek ticket yok
        </td>
      </tr>
    <% } %>

    <% tickets.forEach(t => { %>
      <tr>

        <td><%= t.id %></td>
        <td><%= t.email %></td>
        <td><%= t.department %></td>

        <td style="max-width:420px; white-space:normal;">
          <%= t.issue %>
        </td>

        <td class="text-white-50">
          <%= fmt.format(new Date(t.created_at)) %>
        </td>

        <td>
          <% if (t.resolved) { %>
            <span class="badge bg-secondary">Kapalı</span>
          <% } else { %>
            <span class="badge bg-success">Açık</span>
          <% } %>
        </td>

        <td>
          <% if (t.resolved_at) {
            const diff = new Date(t.resolved_at) - new Date(t.created_at);
            const m = Math.floor(diff / 60000);
            const h = Math.floor(m / 60);
          %>
            <%= h %>s <%= m % 60 %>dk
          <% } else { %>
            —
          <% } %>
        </td>

        <!-- ACTION -->
        <td class="text-end">

          <% if (!t.resolved) { %>
            <!-- KAPAT -->
            <form method="POST"
                  action="/admin/tickets/<%= t.id %>/toggle"
                  class="d-inline">
              <button
                class="btn btn-sm btn-outline-warning px-3 fw-semibold"
                style="min-width:80px">
                Kapat
              </button>
            </form>
          <% } else { %>
            <!-- SİL -->
            <form method="POST"
                  action="/admin/tickets/<%= t.id %>/delete"
                  class="d-inline"
                  onsubmit="return confirm('Bu ticket kalıcı olarak silinsin mi?');">
              <button
                class="btn btn-sm btn-outline-danger px-3 fw-semibold"
                style="min-width:80px">
                Sil
              </button>
            </form>
          <% } %>

        </td>
      </tr>
    <% }) %>
    </tbody>
  </table>

</div>
</body>
</html>
